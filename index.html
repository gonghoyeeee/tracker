<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>月经记录 + 身体变化 + 关系记录（移动优化・分表管理）</title>
<style>
  :root{
    --bg:#ffffff; --card:#ffffff; --muted:#7c847d; --text:#2f3a33; --accent:#d2a889;
    --red:#c97b7b; --green:#9bb39c; --yellow:#d9c48c; --orange:#d2a889; --violet:#9b8bc1; --blue:#7aa7d9;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--text);font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
  .wrap{max-width:1100px;margin:12px auto;padding:0 12px}
  .grid{display:grid;gap:12px}
  @media(min-width:980px){.grid{grid-template-columns:360px 1fr}}
  @media(max-width:979px){.row{flex-direction:column} .kpi{grid-template-columns:1fr 1fr} .card .inner{padding:12px}}
  .card{background:var(--card);border:1px solid rgba(0,0,0,.06);border-radius:16px;box-shadow:0 6px 20px rgba(0,0,0,.06)}
  .card h2{margin:0 0 8px;font-size:18px;color:var(--accent)}
  .card .inner{padding:16px}
  label{display:block;margin:10px 0 6px;color:var(--accent)}
  input,select,button,textarea{font:inherit}
  input[type="date"],select,textarea{width:100%;padding:12px;border-radius:12px;border:1px solid rgba(0,0,0,.12);background:#fff;color:var(--text);outline:none}
  textarea{min-height:68px;resize:vertical}
  .row{display:flex;gap:10px}
  .row>*{flex:1}
  button{cursor:pointer;padding:10px 14px;border-radius:12px;border:1px solid var(--accent);background:#fff;color:var(--accent)}
  button.primary{background:var(--accent);border-color:var(--accent);color:#fff;font-weight:700}
  button.ghost{background:transparent;border-color:var(--accent);color:var(--accent)}
  .muted{color:var(--muted)}
  .tag{display:inline-block;padding:3px 8px;border-radius:999px;font-size:12px;border:1px solid rgba(0,0,0,.12)}
  .kpi{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
  .kpi .item{padding:12px;border-radius:12px;background:#f9f9f9;border:1px solid rgba(0,0,0,.06)}
  .kpi .item b{font-size:18px;color:var(--accent)}
  table{width:100%;border-collapse:collapse}
  th,td{padding:8px;border-bottom:1px solid rgba(0,0,0,.08);text-align:left}
  th{color:var(--muted);font-weight:600}
  /* Calendar */
  .cal{padding:10px}
  .cal-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;color:var(--accent);gap:8px}
  .cal-head .ctrls{display:flex;gap:8px;flex-wrap:wrap}
  .cal-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:6px}
  .dow{font-size:12px;text-align:center;color:var(--muted);margin:4px 0}
  .cell{min-height:74px;border-radius:12px;padding:6px;border:1px solid rgba(0,0,0,.06);background:#fff;position:relative}
  .cell .d{position:absolute;top:6px;right:8px;font-size:12px;color:var(--muted)}
  .cell.today{outline:2px solid var(--accent)}
  .cell .mark{position:absolute;left:6px;bottom:6px;font-size:10px;padding:3px 6px;border-radius:6px;color:#fff;font-weight:700}
  .m{background:var(--red)} /* Menstrual */
  .f{background:var(--green)} /* Fertile */
  .o{background:var(--yellow);color:#2f3a33} /* Ovulation */
  .l{background:var(--orange)} /* Luteal */
  .sx{background:var(--violet)} /* Sex */
  .bn{background:var(--blue)} /* Body Note */
  .pred{outline:1px dashed rgba(0,0,0,.25)}
  .warn{background:#fdeaea;border-left:4px solid var(--red);padding:10px;border-radius:10px}
  .info{background:#fff6f0;border-left:4px solid var(--accent);padding:10px;border-radius:10px}
  .ok{background:#f9f9f9;border-left:4px solid var(--green);padding:10px;border-radius:10px}
</style>
</head>
<body>
  <div class="wrap">
    <h1 style="display:flex;align-items:center;gap:10px;flex-wrap:wrap;margin:0 0 12px;color:var(--accent)">
      <span>月经 + 身体变化 + 关系记录（本地离线）</span>
      <span class="tag">隐私：仅存浏览器本地</span>
      <span class="tag" style="border-color:transparent;background:var(--violet);color:#fff">❤ 关系</span>
      <span class="tag" style="border-color:transparent;background:var(--blue);color:#fff">ⓘ 身体变化</span>
    </h1>

    <div class="grid">
      <!-- 左侧：三个独立表单 + KPI + 导入导出 -->
      <section class="card">
        <div class="inner">
          <h2>姨妈记录</h2>
          <div class="row">
            <div>
              <label>开始</label>
              <input id="pStart" type="date" />
            </div>
            <div>
              <label>结束</label>
              <input id="pEnd" type="date" />
            </div>
          </div>
          <div class="row" style="margin-top:8px">
            <button class="primary" id="btnAddPeriod">添加姨妈记录</button>
          </div>

          <hr style="border:none;border-top:1px solid rgba(0,0,0,.06);margin:12px 0"/>

          <h2>身体变化</h2>
          <div class="row">
            <div>
              <label>日期</label>
              <input id="bDate" type="date" />
            </div>
          </div>
          <label>备注</label>
          <textarea id="bNote" placeholder="如：头痛、情绪低落、乳房胀痛、睡眠差…"></textarea>
          <div class="row" style="margin-top:8px">
            <button class="primary" id="btnAddBody">添加身体变化</button>
          </div>

          <hr style="border:none;border-top:1px solid rgba(0,0,0,.06);margin:12px 0"/>

          <h2>发生关系</h2>
          <div class="row">
            <div>
              <label>日期</label>
              <input id="sDate" type="date" />
            </div>
          </div>
          <div class="row" style="margin-top:8px">
            <button class="primary" id="btnAddSex">添加关系日期</button>
            <button class="ghost" id="btnClearAll">清空全部数据</button>
          </div>

          <hr style="border:none;border-top:1px solid rgba(0,0,0,.06);margin:12px 0"/>

          <h2>统计与预测</h2>
          <div class="kpi">
            <div class="item"><div class="muted">记录周期数</div><b id="kCycles">0</b></div>
            <div class="item"><div class="muted">平均周期（天）</div><b id="kAvg">—</b></div>
            <div class="item"><div class="muted">下次月经预计</div><b id="kNext">—</b></div>
            <div class="item"><div class="muted">易孕窗口</div><b id="kFertile">—</b></div>
          </div>

          <div style="display:flex;gap:8px;margin-top:12px;flex-wrap:wrap">
            <button id="btnExport">导出全部</button>
            <input type="file" id="fileImport" accept="application/json" style="display:none"/>
            <button id="btnImport">导入全部</button>
            <button class="ghost" id="btnResetSamples">恢复示例数据</button>
          </div>

          <div style="margin-top:14px" class="info">
            <b>提示</b>：预测基于平均周期与固定黄体期14天，仅供参考，勿作为避孕依据。如周期明显异常或伴随不适，请就医。
          </div>
        </div>
      </section>

      <!-- 右侧：日历 + 三个表格 -->
      <section class="card cal">
        <div class="cal-head">
          <div style="font-weight:700" id="calTitle">—</div>
          <div class="ctrls">
            <button id="prevM">上个月</button>
            <button id="todayM">今天</button>
            <button id="nextM">下个月</button>
          </div>
        </div>
        <div class="cal-grid" id="dow"></div>
        <div class="cal-grid" id="cal"></div>
        <div style="display:flex;gap:8px;margin-top:10px;flex-wrap:wrap" class="muted">
          <span class="tag" style="border-color:transparent;background:var(--red);color:#fff">月经期</span>
          <span class="tag" style="border-color:transparent;background:var(--green);color:#fff">易孕期</span>
          <span class="tag" style="border-color:transparent;background:var(--yellow);color:#2f3a33">排卵日</span>
          <span class="tag" style="border-color:transparent;background:var(--orange);color:#fff">黄体期</span>
          <span class="tag" style="border-color:transparent;background:var(--violet);color:#fff">❤ 关系</span>
          <span class="tag" style="border-color:transparent;background:var(--blue);color:#fff">ⓘ 身体变化</span>
          <span class="tag" style="color:var(--accent)">虚线：预测</span>
        </div>

        <div class="inner">
          <h2>示例与历史</h2>
          <h3 style="margin-bottom:8px">姨妈历史</h3>
          <table id="tblPeriod">
            <thead><tr><th>开始</th><th>结束</th><th>经期</th><th>周期</th></tr></thead>
            <tbody></tbody>
          </table>

          <h3 style="margin:12px 0 8px">身体变化历史</h3>
          <table id="tblBody">
            <thead><tr><th>日期</th><th>备注</th></tr></thead>
            <tbody></tbody>
          </table>

          <h3 style="margin:12px 0 8px">关系历史</h3>
          <table id="tblSex">
            <thead><tr><th>日期</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </section>
    </div>
  </div>

<script>
// ========== 本地存储键名 ==========
const KEY_PERIOD = 'periodData_v2';
const KEY_BODY   = 'bodyNotes_v2';
const KEY_SEX    = 'sexData_v2';

// ========== 工具函数 ==========
const fmt = d => d.toISOString().slice(0,10);
const parse = s => { const d = new Date(s); d.setHours(12); return d };
const addDays = (d,n)=>{ const x=new Date(d); x.setDate(x.getDate()+n); return x };
const daysBetween = (a,b)=> Math.round((parse(b)-parse(a))/86400000);
const safeHtml = s => (s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');

// ========== 初始示例数据（仅首次或点击“恢复示例数据”时注入） ==========
const SAMPLE = {
  period: [
    { start: '2025-08-03', end: '2025-08-07', periodLen: 5 },
    { start: '2025-09-01', end: '2025-09-05', periodLen: 5 }
  ],
  body: [
    { date: '2025-09-03', note: '轻微腹痛，情绪低落' },
    { date: '2025-09-10', note: '皮肤出油，长痘' },
    { date: '2025-09-18', note: '乳房胀痛，睡眠一般' }
  ],
  sex: [ '2025-09-10', '2025-09-18' ]
};

function loadOrSeed(){
  let p = JSON.parse(localStorage.getItem(KEY_PERIOD) || 'null');
  let b = JSON.parse(localStorage.getItem(KEY_BODY)   || 'null');
  let s = JSON.parse(localStorage.getItem(KEY_SEX)    || 'null');
  if(!p && !b && !s){
    localStorage.setItem(KEY_PERIOD, JSON.stringify(SAMPLE.period));
    localStorage.setItem(KEY_BODY,   JSON.stringify(SAMPLE.body));
    localStorage.setItem(KEY_SEX,    JSON.stringify(SAMPLE.sex));
  }
}
loadOrSeed();

function getPeriod(){ return JSON.parse(localStorage.getItem(KEY_PERIOD) || '[]'); }
function setPeriod(v){ localStorage.setItem(KEY_PERIOD, JSON.stringify(v)); }
function getBody(){ return JSON.parse(localStorage.getItem(KEY_BODY) || '[]'); }
function setBody(v){ localStorage.setItem(KEY_BODY, JSON.stringify(v)); }
function getSex(){ return JSON.parse(localStorage.getItem(KEY_SEX) || '[]'); }
function setSex(v){ localStorage.setItem(KEY_SEX, JSON.stringify(v)); }

// ========== 统计与预测（基于姨妈记录） ==========
function getCycleLengths(){
  const arr = [...getPeriod()].sort((a,b)=> a.start.localeCompare(b.start));
  const res=[]; for(let i=1;i<arr.length;i++){ res.push(daysBetween(arr[i-1].start, arr[i].start)); }
  return res;
}
function avg(arr){ return arr.length? Math.round(arr.reduce((a,b)=>a+b,0)/arr.length) : null }
function getAvgCycle(){ return avg(getCycleLengths()) }
function getLastPeriod(){
  const arr = [...getPeriod()].sort((a,b)=> a.start.localeCompare(b.start));
  return arr.length? arr[arr.length-1] : null;
}
function getPredictions(){
  const last = getLastPeriod();
  if(!last) return { next:null, ovulation:null, fertile:null, windows:[] };
  const avgC = getAvgCycle() || 28;
  const pLen = last.periodLen || daysBetween(last.start,last.end)+1 || 5;

  const nextStart = addDays(parse(last.start), avgC);
  const ovulation = addDays(nextStart, -14);
  const fertile = [ addDays(ovulation,-5), addDays(ovulation,1) ];

  const windows=[];
  const records = [...getPeriod().map(r=>({ start: parse(r.start), end: parse(r.end||r.start), pLen: r.periodLen||5, pred:false }))];
  records.push({ start: parse(fmt(nextStart)), end: addDays(parse(fmt(nextStart)), pLen-1), pLen, pred:true });

  for(let i=0;i<records.length;i++){
    const cur = records[i];
    const nextS = records[i+1]? records[i+1].start : addDays(cur.start, avgC);
    const ovu = addDays(nextS, -14);
    windows.push({ from: cur.start, to: cur.end || addDays(cur.start, (cur.pLen||5)-1), type:'m', pred:cur.pred });
    windows.push({ from: addDays(ovu,-5), to: addDays(ovu,1), type:'f', pred:cur.pred });
    windows.push({ from: ovu, to: ovu, type:'o', pred:cur.pred });
    windows.push({ from: addDays(ovu,2), to: addDays(nextS,-1), type:'l', pred:cur.pred });
  }
  return { next: nextStart, ovulation, fertile, windows };
}

// ========== 渲染表格 ==========
function renderTables(){
  // 姨妈历史
  const p = [...getPeriod()].sort((a,b)=> a.start.localeCompare(b.start));
  const pBody = document.querySelector('#tblPeriod tbody');
  pBody.innerHTML = '';
  for(let i=0;i<p.length;i++){
    const prev = p[i-1];
    const cyc = prev? daysBetween(prev.start, p[i].start) : '—';
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${p[i].start}</td><td>${p[i].end}</td><td>${p[i].periodLen||daysBetween(p[i].start,p[i].end)+1}天</td><td>${cyc}</td>`;
    pBody.appendChild(tr);
  }
  if(!p.length){ pBody.innerHTML = '<tr><td colspan="4" class="muted">暂无记录</td></tr>'; }

  // 身体变化历史
  const b = [...getBody()].sort((a,b)=> a.date.localeCompare(b.date));
  const bBody = document.querySelector('#tblBody tbody');
  bBody.innerHTML = '';
  for(const it of b){
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${it.date}</td><td>${safeHtml(it.note)}</td>`;
    bBody.appendChild(tr);
  }
  if(!b.length){ bBody.innerHTML = '<tr><td colspan="2" class="muted">暂无记录</td></tr>'; }

  // 关系历史
  const s = [...getSex()].sort();
  const sBody = document.querySelector('#tblSex tbody');
  sBody.innerHTML = '';
  for(const d of s){
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${d}</td>`;
    sBody.appendChild(tr);
  }
  if(!s.length){ sBody.innerHTML = '<tr><td class="muted">暂无记录</td></tr>'; }
}

// ========== 日历渲染 ==========
function ensureDow(){
  const dowEl = document.getElementById('dow');
  if(dowEl.dataset.done) return;
  ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'].forEach((d)=>{
    const el=document.createElement('div'); el.className='dow'; el.textContent=d; dowEl.appendChild(el);
  });
  dowEl.dataset.done = '1';
}

function renderCalendar(){
  ensureDow();
  const calEl = document.getElementById('cal');
  calEl.innerHTML='';
  const view = window.__viewDate || new Date();
  const cur = new Date(view); cur.setDate(1); cur.setHours(12);
  const year=cur.getFullYear(), month=cur.getMonth();
  document.getElementById('calTitle').textContent = `${year}年 ${month+1}月`;

  const startIdx = (cur.getDay()+6)%7; // 周一开头
  const daysInMonth = new Date(year, month+1, 0).getDate();
  const today = new Date(); today.setHours(12);

  const { windows } = getPredictions();
  const pWindows = windows;

  // 身体变化 map
  const bodyMap = new Map();
  getBody().forEach(it=>{ bodyMap.set(it.date, (bodyMap.get(it.date)||0)+1 ); });
  // 关系 set
  const sexSet = new Set(getSex());

  const sDay = d => { const x=new Date(d); x.setHours(12); return x };
  function flagsForDate(d){
    const res=[];
    for(const w of pWindows){ if(d>=sDay(w.from) && d<=sDay(w.to)){ res.push({type:w.type, pred:w.pred}); } }
    return res;
  }

  for(let i=0;i<startIdx;i++){ calEl.appendChild(document.createElement('div')); }

  for(let d=1; d<=daysInMonth; d++){
    const cell=document.createElement('div'); cell.className='cell';
    const dd = new Date(year, month, d); dd.setHours(12);
    const dstr = fmt(dd);
    if(fmt(today)===dstr) cell.classList.add('today');
    const num=document.createElement('div'); num.className='d'; num.textContent=d; cell.appendChild(num);

    // 周期窗口标记
    const flags = flagsForDate(dd);
    flags.forEach(f=>{
      const tag=document.createElement('div');
      tag.className = 'mark ' + (f.type==='m'?'m': f.type==='f'?'f': f.type==='o'?'o':'l');
      tag.textContent = f.type==='m'?'月经': f.type==='f'?'易孕': f.type==='o'?'排卵':'黄体';
      if(f.pred) cell.classList.add('pred');
      cell.appendChild(tag);
    });

    // 身体变化标记
    if(bodyMap.has(dstr)){
      const tag=document.createElement('div');
      tag.className='mark bn';
      tag.style.transform='translateY(-24px)';
      tag.textContent='ⓘ 变化';
      cell.appendChild(tag);
    }

    // 关系标记
    if(sexSet.has(dstr)){
      const tag=document.createElement('div');
      tag.className='mark sx';
      tag.style.transform='translateY(-44px)';
      tag.textContent='❤ 关系';
      cell.appendChild(tag);
    }

    calEl.appendChild(cell);
  }
}

// ========== KPI ==========
function renderKPIs(){
  const cycles = getCycleLengths();
  const avgC = getAvgCycle();
  const pred = getPredictions();
  document.getElementById('kCycles').textContent = cycles.length;
  document.getElementById('kAvg').textContent = avgC? avgC+' 天' : '—';
  document.getElementById('kNext').textContent = pred.next? fmt(pred.next) : '—';
  document.getElementById('kFertile').textContent = pred.fertile? `${fmt(pred.fertile[0])} ~ ${fmt(pred.fertile[1])}` : '—';
}

// ========== 事件：新增/清空/导入导出 ==========
document.getElementById('btnAddPeriod').onclick = () => {
  const start = document.getElementById('pStart').value;
  const end = document.getElementById('pEnd').value;
  if(!start||!end) return alert('请填写开始与结束日期');
  if(parse(end) < parse(start)) return alert('结束日期不能早于开始日期');
  const arr = getPeriod();
  const len = daysBetween(start,end)+1;
  arr.push({ start, end, periodLen: len });
  arr.sort((a,b)=> a.start.localeCompare(b.start));
  setPeriod(arr);
  document.getElementById('pStart').value='';
  document.getElementById('pEnd').value='';
  renderAll();
};

document.getElementById('btnAddBody').onclick = () => {
  const date = document.getElementById('bDate').value;
  const note = document.getElementById('bNote').value.trim();
  if(!date) return alert('请填写日期');
  if(!note) return alert('请填写备注');
  const arr = getBody();
  arr.push({ date, note });
  arr.sort((a,b)=> a.date.localeCompare(b.date));
  setBody(arr);
  document.getElementById('bDate').value='';
  document.getElementById('bNote').value='';
  renderAll();
};

document.getElementById('btnAddSex').onclick = () => {
  const date = document.getElementById('sDate').value;
  if(!date) return alert('请选择日期');
  const set = new Set(getSex());
  set.add(date);
  setSex(Array.from(set).sort());
  document.getElementById('sDate').value='';
  renderAll();
};

document.getElementById('btnClearAll').onclick = () => {
  if(confirm('确定清空全部数据？（姨妈、身体变化、关系）')){
    localStorage.removeItem(KEY_PERIOD);
    localStorage.removeItem(KEY_BODY);
    localStorage.removeItem(KEY_SEX);
    renderAll();
  }
};

document.getElementById('btnImport').onclick = () => document.getElementById('fileImport').click();
document.getElementById('fileImport').addEventListener('change', (e)=>{
  const f=e.target.files[0]; if(!f) return;
  const r=new FileReader();
  r.onload=()=>{
    try{
      const incoming = JSON.parse(r.result);
      if(typeof incoming !== 'object') throw new Error('JSON 须为对象');
      if(incoming.period && !Array.isArray(incoming.period)) throw new Error('period 须为数组');
      if(incoming.body && !Array.isArray(incoming.body)) throw new Error('body 须为数组');
      if(incoming.sex && !Array.isArray(incoming.sex)) throw new Error('sex 须为数组');

      if(incoming.period) setPeriod(incoming.period.map(it=>({ start: it.start, end: it.end, periodLen: it.periodLen || (daysBetween(it.start,it.end)+1) })));
      if(incoming.body)   setBody(incoming.body.map(it=>({ date: it.date, note: it.note || '' })));
      if(incoming.sex)    setSex(Array.from(new Set(incoming.sex)).sort());

      renderAll();
    }catch(err){ alert('导入失败：'+err.message) }
  };
  r.readAsText(f);
});

document.getElementById('btnExport').onclick = () => {
  const obj = { period: getPeriod(), body: getBody(), sex: getSex() };
  const blob = new Blob([JSON.stringify(obj,null,2)], {type:'application/json'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='tracker-data.json'; a.click();
};

document.getElementById('btnResetSamples').onclick = () => {
  if(confirm('将清空现有数据并恢复示例，继续？')){
    localStorage.setItem(KEY_PERIOD, JSON.stringify(SAMPLE.period));
    localStorage.setItem(KEY_BODY,   JSON.stringify(SAMPLE.body));
    localStorage.setItem(KEY_SEX,    JSON.stringify(SAMPLE.sex));
    renderAll();
  }
};

// 日历月份切换
window.__viewDate = new Date();
document.getElementById('prevM').onclick = ()=>{ window.__viewDate.setMonth(window.__viewDate.getMonth()-1); renderCalendar(); };
document.getElementById('nextM').onclick = ()=>{ window.__viewDate.setMonth(window.__viewDate.getMonth()+1); renderCalendar(); };
document.getElementById('todayM').onclick = ()=>{ window.__viewDate = new Date(); renderCalendar(); };

// ========== 渲染聚合 ==========
function renderAll(){
  renderKPIs();
  renderCalendar();
  renderTables();
}

// 初始渲染
renderAll();
</script>
</body>
</html>
